<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mochima Simulation Tree</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin-top: 60px;
    }

    button {
      font-size: 16px;
      padding: 10px 16px;
      margin: 6px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover {
      background-color: #45a049;
    }

    #layout {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 40px;
    }

    #scrollArea {
      position: relative;
      width: 100%;
      height: 80vh;
      overflow: scroll;
      border: 1px solid #ccc;
      background: #fdfdfd;
    }

    #zoomCanvas {
      width: 2000px;
      height: 2000px;
      transform-origin: 0 0;
    }

    #layout {
      position: relative;
      width: 2000px;
      height: 2000px;
    }

    #explanation {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      font-size: 16px;
      line-height: 1.4;
      max-width: 80%;
      text-align: center;
    }

    #continue {
      position: fixed;
      bottom: 30px;
      right: 30px;
      font-size: 16px;
      padding: 10px 16px;
      background-color: #007bff;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      z-index: 10;
    }
  </style>
</head>
<body>
  <h1>The Mochima Simulation</h1>
  <h2>An interactive walkthrough of how subgrid physics shape a simulated galaxy</h2>

  <div id="main">
    <button onclick="startExploration()">üöÄ Start Exploration</button>
  </div>

  <script>
    let dragging = false;
    let dragged = false;
    let explained = {
      sf2: false,
      sn2: false,
      proto: false
    };

    function startExploration() {
      document.getElementById("main").innerHTML = `
        <div id="scrollArea">
          <div id="zoomCanvas">
            <div id="layout">
              <img id="img1" src="images/SF0DC.png" alt="Benchmark Simulation"
                style="position: absolute; left: 200px; top: 100px; width: 200px; border-radius: 10px; z-index: 1;" />
              <div style="position: absolute; left: 450px; top: 100px; z-index: 2;">
                <button onclick="showExplanation('sf')">üåü Star Formation</button><br>
                <button onclick="showExplanation('sn')">üí• Supernova Feedback</button>
              </div>
            </div>
          </div>
        </div>

        <div id="explanation"></div>
        <button id="continue" onclick="continueTree()">‚û°Ô∏è Continue</button>
        <div id="zoomControls" style="position: fixed; bottom: 100px; right: 30px; z-index: 10;">
          <button onclick="zoomIn()">‚ûï</button>
          <button onclick="zoomOut()">‚ûñ</button>
        </div>
      `;
    }

    function showExplanation(type) {
      const el = document.getElementById("explanation");

      if (el.dataset.last === type && el.style.display === "block") {
        el.style.display = "none";
        el.dataset.last = "";
        return;
      }

      el.dataset.last = type;
      el.style.display = "block";

      if (type === "sf") {
        el.innerHTML = `
          <h3>üåü Star Formation (Fixed Efficiency)</h3>
          <p>
            In this benchmark simulation, star formation is governed by a fixed efficiency. Stars form in cold, dense gas regions following a Schmidt law.
          </p>
        `;
      } else if (type === "sn") {
        el.innerHTML = `
          <h3>üí• Supernova Feedback (Delayed Cooling)</h3>
          <p>
            Supernova explosions inject energy into the gas and temporarily shut off cooling in the surrounding region to allow the blast to affect dynamics.
          </p>
        `;
      } else if (type === "sf2") {
        let html = `
          <h3>üå™Ô∏è Turbulent Star Formation</h3>
          <p>
            In this model, star formation efficiency varies with local gas turbulence. The local gas velocity dispersion will impact the efficiency of star formation as described by the multi-freefall models.
          </p>
        `;
        if (!explained.sf2) {
          html = `
            <div style="background: #e6f9e6; padding: 10px; border-radius: 8px;">
              ${html}
              <p style="font-style: italic; color: gray;"> New.</p>
            </div>
          `;
          explained.sf2 = true;
        }
        el.innerHTML = html;
      } else if (type === "sn2") {
        let html = `
          <h3>üß® Mechanical Supernova Feedback</h3>
          <p>
              Momentum and energy from supernovae are injected based on resolved physics,
              pushing and heating surrounding gas more realistically than delayed cooling.
          </p>
         `;
         if (!explained.sn2) {
           html = `
             <div style="background: #e6f9e6; padding: 10px; border-radius: 8px;">
               ${html}
               <p style="font-style: italic; color: gray;"> New.</p>
             </div>
         `;
         explained.sn2 = true;
       }
       el.innerHTML = html;
       } else if (type === "proto") {
         let html = `
          <h3>üå† Protostellar Feedback</h3>
          <p>
            Protostellar outflows reduce star formation by preventing collapse in early phases. This is controlled by a suppression factor (100% = no suppression, 0% = full suppression).
          </p>
         `;
         if (!explained.proto) {
          html = `
           <div style="background: #e6f9e6; padding: 10px; border-radius: 8px;">
             ${html}
             <p style="font-style: italic; color: gray;"> New.</p>
           </div>
         `;
         explained.proto = true;
       }
       el.innerHTML = html;
     }
    } // ‚úÖ <- this closes showExplanation
    
    function startDragGeneric(e, wrapperId, lineId = null) {
        const wrapper = document.getElementById(wrapperId);
        const lineEl = lineId ? document.getElementById(lineId) : null;

        dragStartX = e.clientX;
        dragStartY = e.clientY;
        isDragging = false;

        offsetX = e.clientX - wrapper.offsetLeft;
        offsetY = e.clientY - wrapper.offsetTop;

        const onMove = (e) => {
          const dx = Math.abs(e.clientX - dragStartX);
          const dy = Math.abs(e.clientY - dragStartY);

          if (dx > dragThreshold || dy > dragThreshold) {
             isDragging = true;
          }

          if (isDragging) {
             const x = e.clientX - offsetX;
             const y = e.clientY - offsetY;

             wrapper.style.left = x + "px";
             wrapper.style.top = y + "px";

             // Update connected line if provided
             if (lineEl) {
               lineEl.setAttribute("x2", x + 100); // center of image
               lineEl.setAttribute("y2", y + 100);
             }
         }
        };

        const onUp = () => {
          document.removeEventListener("mousemove", onMove);
          document.removeEventListener("mouseup", onUp);
        };

        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onUp);
    }


    function toggleButtons2() {
      const btns = document.getElementById("buttons2");
      const wrapper = document.getElementById("img2wrapper");

      const x = parseInt(wrapper.style.left || wrapper.offsetLeft);
      const y = parseInt(wrapper.style.top || wrapper.offsetTop);

      btns.style.left = (x + 220) + "px";
      btns.style.top = y + "px";

      btns.style.display = btns.style.display === "block" ? "none" : "block";
    }

    function continueTree() {
      document.getElementById("explanation").style.display = "none";
      document.getElementById("continue").style.display = "none";

      const layout = document.getElementById("layout");
      layout.style.position = "relative";

      layout.insertAdjacentHTML("beforeend", `
        <svg id="connector" width="2000" height="2000" style="position: absolute; top: 0; left: 0; z-index: 0;">
          <line id="line1" x1="300" y1="200" x2="300" y2="600" stroke="#999" stroke-width="2" />
        </svg>

        <div id="img2wrapper" style="position: absolute; left: 200px; top: 550px; width: 200px; z-index: 1; cursor: grab;" onmousedown="startDrag(event)">
          <img id="img2" src="images/SF1DCe1.png" style="width: 200px; border-radius: 10px;" />
        </div>
      `);

      setTimeout(() => {
       const wrapper = document.getElementById("img2wrapper");
       wrapper.addEventListener("click", (e) => {
         if (!dragged) toggleButtons2();
       });
      }, 0);

      layout.insertAdjacentHTML("beforeend", `
        <div id="buttons2" style="display: none; position: absolute; left: 420px; top: 550px; z-index: 2;">
          <button onclick="showExplanation('sf2')">üå™Ô∏è Turbulent SF</button><br>
          <button onclick="showExplanation('sn')">üí• Supernova Feedback</button> 
        </div>
      `);
      layout.insertAdjacentHTML("beforeend", `
        <div id="branchButtons" style="position: absolute; left: 200px; top: 760px; z-index: 2;">
          <button onclick="addMechanicalSN()">üß® Switch to Mechanical SN</button>
          <button onclick="addProtoFeedback()">üå† Add Protostellar Feedback</button>
        </div>
      `);
    }
    function addMechanicalSN() {
      const layout = document.getElementById("layout");

      layout.insertAdjacentHTML("beforeend", `
        <svg width="2000" height="2000" style="position: absolute; top: 0; left: 0; z-index: 0;">
           <line id="line_mech" x1="300" y1="650" x2="500" y2="900" stroke="#999" stroke-width="2" />
        </svg>
        <div id="img3wrapper" 
             style="position: absolute; left: 400px; top: 850px; width: 200px; z-index: 1; cursor: grab;" 
             onmousedown="startDragGeneric(event, 'img3wrapper', 'line_mech')">
          <img id="img3" src="images/SF1MEe1.png" style="width: 200px; border-radius: 10px;" />
        </div>
        <div style="position: absolute; left: 620px; top: 850px; z-index: 2;">
          <button onclick="showExplanation('sf2')">üå™Ô∏è Turbulent SF</button><br>
          <button onclick="showExplanation('sn2')">üß® Mechanical Feedback</button>
        </div>
      `);
    }
    function addProtoFeedback() {
      const layout = document.getElementById("layout");

      layout.insertAdjacentHTML("beforeend", `
        <svg width="2000" height="2000" style="position: absolute; top: 0; left: 0; z-index: 0;">
          <line id="line_proto" x1="300" y1="650" x2="100" y2="900" stroke="#999" stroke-width="2" />
        </svg>
        <div id="img4wrapper" 
             style="position: absolute; left: 0px; top: 850px; width: 200px; z-index: 1; cursor: grab;"
             onmousedown="startDragGeneric(event, 'img4wrapper', 'line_proto')">
          <img id="img4" src="images/SF1DC.png" style="width: 200px; border-radius: 10px;" />
        </div>
        <div style="position: absolute; left: 220px; top: 850px; z-index: 2;">
          <button onclick="showExplanation('sf2')">üå™Ô∏è Turbulent SF</button><br>
          <button onclick="showExplanation('proto')">üå† Protostellar Feedback</button>
        </div>
       `);
     }
    let offsetX, offsetY;
    const line = () => document.getElementById("line1");
    let isDragging = false;
    let dragThreshold = 5;
    let dragStartX = 0;
    let dragStartY = 0;

    function startDrag(e) {
	  const wrapper = document.getElementById("img2wrapper");

	  dragStartX = e.clientX;
	  dragStartY = e.clientY;
	  isDragging = false;

	  offsetX = e.clientX - wrapper.offsetLeft;
	  offsetY = e.clientY - wrapper.offsetTop;

	  const onMove = (e) => {
		const dx = Math.abs(e.clientX - dragStartX);
		const dy = Math.abs(e.clientY - dragStartY);

		if (dx > dragThreshold || dy > dragThreshold) {
		  isDragging = true;
		}

		if (isDragging) {
		  const x = e.clientX - offsetX;
		  const y = e.clientY - offsetY;

		  wrapper.style.left = x + "px";
		  wrapper.style.top = y + "px";

		  line().setAttribute("x2", x + 100);
		  line().setAttribute("y2", y + 100);
          // Also update branch lines if they exist
          const lineMech = document.getElementById("line_mech");
          if (lineMech) {
           lineMech.setAttribute("x1", x + 100); // image center x
           lineMech.setAttribute("y1", y + 100); // image center y
          }

          const lineProto = document.getElementById("line_proto");
          if (lineProto) {
           lineProto.setAttribute("x1", x + 100);
           lineProto.setAttribute("y1", y + 100);
          }

		  document.getElementById("buttons2").style.display = "none";
		}
	  };

	  const onUp = () => {
		document.removeEventListener("mousemove", onMove);
		document.removeEventListener("mouseup", onUp);

		if (!isDragging) {
		  toggleButtons2(); // Only if it was a click
		} else {
		  document.getElementById("buttons2").style.display = "block";
		}
	  };

	  document.addEventListener("mousemove", onMove);
	  document.addEventListener("mouseup", onUp);
      
    }

    let zoomLevel = 1;
    function zoomIn() {
      zoomLevel *= 1.1;
      document.getElementById("zoomCanvas").style.transform = `scale(${zoomLevel})`;
    }

    function zoomOut() {
      zoomLevel /= 1.1;
      document.getElementById("zoomCanvas").style.transform = `scale(${zoomLevel})`;
    }
  </script>
</body>
</html>
